# QQGroupAlbumDownload 代码架构文档

## 1. 项目概述

QQGroupAlbumDownload 是一款基于 Electron 和 Vue 3 开发的桌面应用程序，用于批量下载 QQ 群相册中的照片和视频。该应用通过模拟 QQ 登录和请求 QQ 空间 API，实现了对指定 QQ 群相册内容的高效获取和本地存储。

## 2. 技术栈

- **前端框架**: Vue 3 (TypeScript)
- **UI 组件库**: Element Plus
- **构建工具**: Vue CLI
- **桌面应用框架**: Electron
- **HTTP 请求库**: Axios
- **文件操作**: fs-extra
- **加密工具**: crypto-js
- **代码规范**: ESLint, Prettier

## 3. 项目目录结构

项目采用 Electron 与 Vue 结合的标准目录结构，清晰分离了主进程、渲染进程和公共模块：

```
├── main.js                # Electron 主进程入口文件
├── ipcMain.js             # 主进程 IPC 通信处理逻辑
├── preload.js             # 预加载脚本，提供安全的渲染进程 API 访问
├── qqCore.js              # QQ 相关核心功能（Cookie、Token 管理）
├── consts.js              # 常量定义
├── src/                   # Vue 前端源码
│   ├── App.vue            # 主组件
│   ├── main.ts            # Vue 应用入口
│   ├── components/        # Vue 组件
│   │   ├── InputGroup.vue # 输入群号界面
│   │   ├── SelectAlbum.vue # 选择相册界面
│   │   └── DownloadPage.vue # 下载页面
│   ├── router/            # 路由配置
│   └── utils.ts           # 工具函数
├── public/                # 静态资源
└── package.json           # 项目配置和依赖
```

## 4. 系统架构与主流程

### 4.1 架构概览

系统采用 Electron 的双进程架构模式：

- **主进程**: 负责窗口管理、QQ 登录认证、文件操作和网络请求等系统级功能
- **渲染进程**: 负责用户界面渲染和交互逻辑，基于 Vue 3 实现
- **IPC 通信**: 主进程与渲染进程之间通过 Electron 的 IPC 机制进行通信
- **数据共享**: 通过 qqCore.js 模块在主进程中共享 QQ 登录信息

### 4.2 核心流程

系统的主要业务流程可分为以下几个阶段：

1. **用户登录阶段**
   - 应用启动时创建登录窗口
   - 用户在登录窗口完成 QQ 账号登录
   - 系统自动提取登录凭证（Cookie、Token）并保存
   - 关闭登录窗口，创建主应用窗口

2. **相册获取阶段**
   - 用户输入 QQ 群号并确认
   - 主进程通过 QQ 空间 API 获取指定群的相册列表
   - 将相册列表返回给渲染进程显示

3. **相册选择阶段**
   - 用户选择需要下载的相册
   - 系统记录用户的选择

4. **下载执行阶段**
   - 用户确认开始下载任务
   - 系统创建下载任务队列
   - 依次下载每个相册中的媒体文件
   - 实时显示下载进度和状态
   - 提供暂停、继续、删除等任务控制功能

## 5. 核心模块详解

### 5.1 Electron 主进程模块 (main.js)

主进程模块是应用的入口点，负责窗口管理和生命周期控制。主要功能包括：

- 创建 QQ 登录窗口和主应用窗口
- 监听登录窗口的 URL 变化，提取登录凭证
- 计算并设置 Token 值
- 管理应用窗口的显示、隐藏和关闭

核心功能实现：

```javascript
// 创建登录窗口
function createWindow() {
  loginWindow = new BrowserWindow({/* 配置参数 */});
  loginWindow.loadURL(QQURL);
  // 监听登录状态并提取凭证
  loginWindow.webContents.on("dom-ready", () => { /* 提取 Cookie 逻辑 */ });
}

// 生成 Token
function generateTK(str) {
  let hash = 5381;
  for (let i = 0, len = str.length; i < len; i++) {
    hash += (hash << 5) + str.charCodeAt(i);
  }
  return hash & 0x7fffffff;
}
```

### 5.2 QQ 核心功能模块 (qqCore.js)

此模块提供了 QQ 登录凭证的存储和访问功能，是连接登录和 API 请求的关键桥梁：

- 存储用户登录后的 Cookie、Token 和 QQ 号
- 提供设置和获取这些凭证的接口
- 作为全局共享的数据中心，供 IPC 通信模块使用

```javascript
let cookieStr = "";
let tk = "";
let qq = "";
exports.setTk = (value) => { tk = value; };
exports.getTk = () => { return tk; };
// 其他设置和获取函数...
```

### 5.3 IPC 通信模块 (ipcMain.js)

这是应用的核心业务逻辑模块，处理主进程与渲染进程之间的通信并执行实际的业务操作：

- 注册各种 IPC 事件处理器
- 实现相册列表获取、照片下载等核心功能
- 管理下载任务队列和状态
- 处理文件保存和错误情况

关键功能包括：

```javascript
// 获取相册列表
async function getAlbumList(event, qunId) {
  const url = `https://h5.qzone.qq.com/proxy/domain/u.photo.qzone.qq.com/cgi-bin/upp/qun_list_album_v2?g_tk=${getTk()}&callback=shine2_Callback&qunId=${qunId}&uin=${getQQ()}&start=0&num=1000&getMemberRole=1&inCharset=utf-8&outCharset=utf-8&source=qzone&attach_info=&callbackFun=shine2`;
  try {
    const { data } = await axios.get(url, { headers: { Cookie: getCookies() } });
    // 处理响应数据...
  } catch (error) {
    // 错误处理...
  }
}

// 其他功能函数：获取相册内容、创建下载任务、暂停/恢复/删除任务等
```

### 5.4 预加载脚本模块 (preload.js)

预加载脚本为渲染进程提供了安全访问主进程 API 的桥梁，遵循 Electron 的安全最佳实践：

- 使用 contextBridge 安全地暴露 API 到渲染进程
- 定义渲染进程可调用的功能接口
- 防止渲染进程直接访问 Node.js API

```javascript
const { contextBridge, ipcRenderer } = require("electron");

const preloadInjectObj = {
  openPage: (url) => ipcRenderer.invoke("openPage", url),
  startDownloadAlbum: () => ipcRenderer.invoke("startDownloadAlbum"),
  getAlbumList: (qqGroup) => ipcRenderer.invoke("getAlbumList", qqGroup),
  // 其他 API 接口...
};

contextBridge.exposeInMainWorld("QQ", preloadInjectObj);
```

### 5.5 Vue 主组件 (App.vue)

Vue 应用的根组件，管理整体的用户界面流程和状态：

- 实现三步式界面导航（输入群号 → 选择相册 → 处理任务）
- 管理应用状态和数据流
- 协调各子组件之间的交互

```vue
<template>
  <div class="main">
    <el-steps simple :active="stepActive">
      <el-step title="输入群号" :icon="Edit" />
      <el-step title="选择相册" :icon="PictureRounded" />
      <el-step title="处理任务" :icon="Download" />
    </el-steps>
    <!-- 各步骤对应的组件 -->
    <div v-if="stepActive == 0"><InputGroup /></div>
    <div v-if="stepActive == 1"><SelectAlbum /></div>
    <div v-if="stepActive == 2"><DownloadPage /></div>
  </div>
</template>
```

### 5.6 输入群号组件 (InputGroup.vue)

处理用户输入 QQ 群号的界面，提供基本的输入验证和辅助链接：

- 提供 QQ 群号输入框和确认按钮
- 实现输入格式验证
- 提供开源地址、作者寄语等辅助链接
- 触发获取相册列表的操作

### 5.7 选择相册组件 (SelectAlbum.vue)

显示并允许用户选择要下载的相册：

- 以表格形式展示相册列表
- 支持多选相册
- 提供下载和返回功能

### 5.8 下载页面组件 (DownloadPage.vue)

显示和管理下载任务的界面：

- 展示当前下载任务状态
- 提供任务控制功能（暂停、继续、删除）
- 支持批量操作
- 实时更新下载进度

### 5.9 工具函数模块 (utils.ts)

提供应用中使用的通用工具函数：

- 实现深度转换响应式对象为普通对象的功能
- 支持处理嵌套对象和数组

```typescript
export function deepToRaw<T extends Record<string, any>>(sourceObj: T): T {
  const objectIterator = (input: any): any => {
    // 递归处理各种类型的数据...
  };
  return objectIterator(sourceObj);
}
```

## 6. 任务管理系统

项目实现了一个简单但有效的任务管理系统，通过 consts.js 中定义的状态常量来管理下载任务的生命周期：

```javascript
const TaskStatus = {
  WATING: "wating",  // 等待状态
  RUN: "run",        // 运行状态
  FINISH: "finish",  // 完成状态
  ERROR: "error",    // 错误状态
  PAUSE: "pause"     // 暂停状态
};
```

任务状态流程：
- 任务创建 → WATING 状态
- 开始下载 → RUN 状态
- 暂停下载 → PAUSE 状态
- 下载完成 → FINISH 状态
- 出现错误 → ERROR 状态

## 7. 网络请求与 API 交互

应用通过 Axios 库与 QQ 空间 API 进行交互，主要包括以下几种请求：

1. **获取相册列表**：通过 GET 请求获取指定 QQ 群的所有相册信息
2. **获取相册内容**：通过 POST 请求获取指定相册中的照片和视频列表
3. **下载媒体文件**：通过 HTTP 请求下载照片和视频文件

所有请求都需要附带登录凭证（Cookie 和 Token）以通过 QQ 的身份验证。

## 8. 安全性考虑

项目在设计中考虑了以下安全因素：

- 使用 contextBridge 安全暴露 API 到渲染进程
- 不存储用户的 QQ 密码，只临时保存登录凭证
- 遵循 Electron 的安全最佳实践
- 防止 XSS 和恶意脚本注入

## 9. 构建与打包

项目使用 electron-builder 进行应用打包，支持构建为便携式可执行文件：

```json
"build": {
  "appId": "qq.album.download",
  "copyright": "LiHengDao",
  "icon": "logo.ico",
  "productName": "QQGroupAlbumDownload",
  "win": {
    "target": ["portable"],
    "artifactName": "${productName} ${version}.${ext}"
  }
}
```

## 10. 总结与亮点回顾

QQGroupAlbumDownload 项目成功结合了 Electron 和 Vue 3 的优势，实现了一个功能完整的 QQ 群相册批量下载工具。其主要亮点包括：

1. **架构清晰**：采用 Electron 的主进程和渲染进程分离架构，职责分明
2. **用户体验优化**：三步式向导界面，操作简单直观
3. **功能完整**：支持批量下载、任务控制、进度显示等功能
4. **安全可靠**：遵循 Electron 安全最佳实践，保护用户数据安全
5. **代码规范**：使用 TypeScript 和 ESLint 保证代码质量

该项目不仅解决了 QQ 群相册批量下载的实际需求，也为类似的 Electron + Vue 桌面应用开发提供了良好的参考。